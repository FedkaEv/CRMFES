<html>
    <head>
    <title> Проекти   </title>

    </head>

    <body>


        <div class="row" zippy="projectpanel">
            <div class="col-12  ">
                <h2>Проекти</h2>
                <div class="navbar nav  ">
                    <form zippy="filter" class="form-inline ">
                        <input placeholder="Пошук..." class="form-control mr-2" type="text" zippy="searchnumber">

                        <label for="searchstate">статус </label>
                        <select class="form-control  mr-2   " zippy="searchstate">
                            <option value="0">Відкриті</option>
                        </select>
                        <label for="searchcust">замовник </label>
                        <select class="form-control     " zippy="searchcust">
                            <option value="0">Не обрано</option>
                        </select>


                        <input type="submit" class=" ml-2   btn btn-outline-success  " value="ОК">
                    </form>

                </div>
            </div>
            <div class="col-12 col-xl-10 ">
                <a zippy="padd" class="btn btn-primary  ">Новий проект</a>
                <table class="table table-bordered  table-sm">
                    <tr>
                        <th>Назва</th>
                        <th>Замовник</th>
                        <th>Статус</th>
                        <th colspan="3" class="text-center">Завдання</th>

                        <th></th>
                    </tr>
                    <tr zippy="projectlist">
                        <td zippy="project_name"></td>
                        <td zippy="customer_name"></td>
                        <td zippy="status"></td>
                        <td style="width:40px"><span zippy="inew" title="Нові" class="badge badge-success  "></span></td>
                        <td style="width:40px"><span zippy="iproc" title="В роботі" class="badge badge-primary"></span></td>
                        <td style="width:40px"><span zippy="iclose" title="Закриті" class="badge badge-secondary"></span></td>

                        <td>
                            <a zippy="preview"><i class="fa fa-eye"/></a>
                            &nbsp;&nbsp;
                            <a zippy="edit" title="Редагувати"><i class="fa fa-edit"></i></a>

                            &nbsp;&nbsp;
                            <a zippy="delete" title="Вилучити"><i class="fa fa-trash"></i></a></td>
                    </tr>
                </table>
                <div zippy="pag"></div>
            </div>

        </div>
     
        <div class="row" zippy="showpan">
            <div class="col-12 col-md-8 col-xl-6">
                <a zippy="back"><i class="fa fa-arrow-circle-left"></i> До списку</a>
                &nbsp; &nbsp; <a zippy="toilist"> До списку завдань</a>
                &nbsp; &nbsp; <a zippy="newissue"> Створити завдання</a>
                <h4 zippy="mtitle"></h4>

               

                <hr>
                <a id="afiles">
                    <form class="form-inline" zippy="addfileform" enctype="multipart/form-data">
                        <input type="hidden" name="MAX_FILE_SIZE" value="5000000">
                        <label> Вибрати файл: </label>

                        <input class="form-control mr-2" type="file" required="required" zippy="addfile">

                        <input class="btn btn-outline-info  " type="submit" value="Додати">

                    </form>

                    <div zippy="filelist" style="float:left">

                        <i class="fa fa-paperclip"></i> <a zippy="filename" target="_blank"></a>
                        &nbsp;<a zippy="delfile" class="text-danger  text-bold" title="Вилучити">x</a>&nbsp;&nbsp;

                    </div>


                    <hr>
                    <h5>Коментарі</h5>
                    <table style="width:400px" class="table table-sm">
                        <tr zippy="msglist">
                            <td>
                                <span><b zippy="msguser"></b> <span zippy="msgdate"
                                                                    class="text-muted float-right"></span></span>

                                <br><span zippy="msgdata"></span>

                            </td>
                            <td valign="top"><a zippy="delmsg" class="text-danger text-bold">x</a></td>
                        </tr>
                    </table>
                    <div zippy="pagmsg"></div>
                    <a id="amessages"/>
                    <form style="margin-left:40px;" zippy="addmsgform" id="msgankor">
                        <label> Коментар: </label>
                        <div class="form-group">
                            <textarea class="form-control" required="required" zippy="msgdata"
                                      style="width:400px;height:120px;"></textarea>
                        </div>
                        <input class="btn btn-outline-success  " type="submit" value="Додати">
                    </form>

            </div>
            <div class="col-12 col-md-4 col-xl-3">
                <form zippy="statusform">
                    <div class="form-group">
                        <label for="stlist">Статус </label>
                        <select class="form-control     " zippy="stlist">

                        </select>
                    </div>
                    <div class="form-group">
                        <input type="submit" class=" ml-2   btn btn-outline-success  " value="Змінити">
                    </div>

                </form>
                <h4>Опис</h4>
           <p zippy="mdesc"></p>
            </div>
        </div>
   
    {{={| |}=}}   
    
        <div class="row"  id="vapp" >
            <div v-show="this.mode=='list'" class="col-12   ">
                <h2>Проекти</h2>
                <div class="navbar nav  ">
                    <form   class="form-inline ">
                        <input  v-model="searchtext" placeholder="Пошук..." class="form-control mr-2" type="text"  >

                        <label for="searchstate">статус </label>
                        <select v-model="searchstate" class="form-control  mr-2   "  >
                            <option value="0">Відкриті</option>
                           <option v-for="option in stlist" :value="option.key">
                              {{ option.value }}
                          </option>                            
                        </select>
                        <label for="searchcust">замовник </label>
                        <select v-model="searchcust" class="form-control     "  >
                           <option value="0">Не вибраний</option>
                
                           <option v-for="option in custlist" :value="option.key">
                              {{ option.value }}
                          </option>
                       </select>

                      
                        <input v-on:click.prevent="onsearch" type="button" class=" ml-2   btn btn-success  " value="ОК">
                    </form>

                </div>
            </div>
            <div v-show="this.mode=='list'" class="col-12 col-md-10 col-xl-8 ">
                <a  v-on:click.prevent="add()"  class="btn btn-primary  ">Новий проект</a>
                <table class="table table-bordered  table-sm">
                    <tr>
                        <th>Назва</th>
                        <th>Замовник</th>
                        <th>Статус</th>
                        <th colspan="3" class="text-center">Завдання</th>

                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    <tr  v-for="project,index  in projectlist">
                        <td  >{{project.project_name}}</td>
                        <td  >{{project.customer_name}}</td>
                        <td  >{{project.status}}</td>
                        <td style="width:40px" ><span   title="Нові" class="badge badge-success  " v-show="project.inew>0">{{project.inew}}</span></td>
                        <td style="width:40px"><span   title="В роботі" class="badge badge-primary" v-show="project.iproc>0">{{project.iproc}}</span></td>
                        <td style="width:40px"><span   title="Закриті" class="badge badge-secondary" v-show="project.iclose>0">{{project.iclose}}</span></td>

                        <td>
                            <a  ><i class="fa fa-eye"/></a>
                         </td>
                         <td>   
                            <a  v-show="project.allowedit" v-on:click.prevent="edit(project.project_id)"   title="Редагувати" href="javascript:void(0)" ><i class="fa fa-edit"></i></a>
                         </td>
                         <td>
                           
                            <a  v-show="project.allowdel" v-on:click.prevent="del(project.project_id,project.project_name)"   title="Вилучити" href="javascript:void(0)" ><i class="fa fa-trash"></i></a>
                         </td>
                    </tr>
                </table>
               <paginator  v-on:onpage="changepage"  v-bind:rows="rowscnt" v-bind:pagesize="pagesize" buttonscnt="10"></paginator>
 
            </div>

            
            <div v-show="this.mode=='edit'" class="col-12">
                <form    method="post">
                    <div class="row">
                        <div class="col-12 col-md-8  col-xl-6">

                            <div class="form-group">
                                <label for="editname"> Назва</label>
                                <input v-model="editname" id="editname" name="editname" class="form-control" type="text"    >
                            </div>
                            <div class="form-group">
                                <label for="editcust"> Замовник </label>
                                <typeahead     ref="cust"  :onquery="ontext"  :onhit="hitcust" placeholder="Почнiть вводити ..."></typeahead>   

                            </div>
                            <div class="form-group">
                                <label for="editdesc"> Опис </label>
                                <div  id="editdesc" class="form-control mr-2"  ></div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4  col-xl-4">
                            <div class="form-group">
                                <label> Список учасникiв </label>
                                <div ></div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4  col-xl-4">

                            <div class="form-group">
                                <input v-on:click.prevent="onsave" type="button" value="Зберегти" class="btn btn-outline-primary  "> &nbsp;
                                <input v-on:click.prevent="onback"  type="button" value="Скасувати" class="btn btn-outline-secondary ">
                            </div>

                        </div>
                    </div>
                </form>
            </div>            
            
        </div>

    {|={{ }}=|}      
    

        <script>
        
        
     var vapp = new Vue({
            el: '#vapp',
      
      data() { return {
          projectlist:[] ,
          stlist:[] ,
          custlist:[] ,
          rowscnt:0,
          searchtext:'' ,
          searchcust:'0' ,
          searchstate:'0',
          editid:0 ,
          editname:'' ,
          cname:'' ,
     
          editcust:0,
          pagesize:25  ,
          mode:'list'
      } } ,
     components: {
    
     'typeahead': httpVueLoader('/assets/js/vue/typeahead.vue')
    , 'paginator': httpVueLoader('/assets/js/vue/paginator.vue')
   
           
        }, 
        methods: {
            del:function( project_id,name){    
                
               if(confirm("Видалити  проект '"+name+"'?"))
               {                
                  callPageMethod('del',[project_id], null,(data)=> 
                  {                                
                       if(data != ""){
                          toastr.error( data ,'',{'timeOut':'8000'})
               
                       } else {
                           
                       }           
                       this.loaddata();
                      
                  });      
               } 
            }   ,
            edit:function( project_id){    
                  this.editid = project_id;
                
                  callPageMethod('getedit',[project_id], null,(data)=> 
                  {                                
                       let tmp =   JSON.parse(data)  
                     
                       this.editname=tmp.name;   
                       this.editcust=tmp.customer_id;
                       this.cname=tmp.customer_name;  
                       $('#editdesc').summernote("code",tmp.desc)
                       
                       this.mode='edit'  
                  });               
                
                 
            }   ,     
            add:function( project_id){    
                  this.editid = 0
                  this.editname =""
                  $('#editdesc').summernote("code","")                
                  this.$refs.cust.query = "";       
                  this.mode='edit'  
                  this.cname=''  
                
                 
            }   ,
                 hitcust: function (id){
            
                    this.editcust = id 
                },
                ontext: async function (query){
                   
                    var url  = getMethodUrl('ontextCustomers',[query ])
                    let response = await fetch(url);
             
                    return  await response.json()  ;
     
                }  ,
       
        onsave:function(  ){    
                  
                  var data = new  FormData();
                  data.append('name',  this.editname);
                  data.append('customer_id',  this.editcust);
                  data.append('desc',   $('#editdesc').summernote("code")                );
                  
                  callPageMethod('save',[this.editid], data,(data)=> 
                  {                                
                       if(data==""){ 
                         this.mode='list' 
                         this.loaddata(); 
                       } else {
                           alert(data);
                       }
                  });               
                
                 
            }   ,
            
            
            
            onback:function(  ){    
                
                 this.mode='list'
                
                 
            }   ,
            changepage:function( page){    //кнопка  пагинатора
                
                 this.loaddata( (page-1) * this.pagesize );
            }   ,
            loaddata: function(start=0){
                let body={
                    searchnumber:"",
                    searchcust:this.searchcust,
                    searchstate:this.searchstate,
                    start:start,

                    count:this.pagesize 
                };
                
                  callPageMethod('getList',null, JSON.stringify(body),(data)=> 
                  {
                      let tmp =   JSON.parse(data)  
                      this.projectlist=  tmp.prlist
                     
                      this.rowscnt=tmp.cnt
                      this.custlist=tmp.custlist
                  });
            }  ,
            onsearch:function (){
                this.rowscnt=0;
                this.loaddata();
            }  
           
            
        }  ,
        mounted: function(){
            
                  callPageMethod('init',null, null,(data)=> 
                  {
                      let tmp =   JSON.parse(data)  
                      this.stlist=  tmp.stlist
                     
                 
                      this.pagesize=tmp.pagesize
                      this.loaddata();
                  });            
            
        }
      
    })
 
   
          
        
           

                $('#editdesc').summernote({
                    height: 400,
                    lang: 'uk-UA',

                    callbacks: {
                        onEnter: function (e) {
                            if (e.keyCode === key.code.ENTER) {
                                e.shiftKey = true;
                                context.triggerEvent('enter', e);
                            }
                        },
                        onPaste: function (e) {

                            var bufferText = ((e.originalEvent || e).clipboardData || window.clipboardData).getData('Text');
                            e.preventDefault();
                            document.execCommand('insertText', false, bufferText.replace(/\n/g, ''));
                        }
                    }
                });

         
        </script>
    </body>
</html>
